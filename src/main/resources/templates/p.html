<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Recipe Book</title>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8"/>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"/>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular.min.js"></script>
</head>
<script type="text/javascript">
    var app = angular.module("RECIPES", []);
    app.controller("RECIPES_CTRL", function($scope, $http){



    $scope.steps = [];
    $scope.ingridients = [];
    $scope.countIngridients = 0;
    $scope.countSteps = 0;

    $scope.csrf = document.querySelector("meta[name='_csrf']").content;


    $scope.getIngridients = function(){
    $http({
    url: '/get_ingridients_to_add',
    method: 'GET'
    }).then(function(response){
    $scope.ingridients = response.data;
    });
    }

    $scope.getSteps = function(){
    $http({
    url: '/get_steps_to_add',
    method: 'GET'
    }).then(function(response){
    $scope.steps = response.data;
    $scope.getIngridients();
    });
    }

    $scope.getSteps();


    $scope.addNewIngridients = function(){
    $http({
    url: '/add_new_ingridients',
    method: 'POST',
    params: {countIngridients: $scope.countIngridients},
    headers: {
    'X-CSRF-TOKEN': $scope.csrf
    }
    }).then(function(){
    $scope.countIngridients += 1;
    $scope.getIngridients();
    });
    }


    $scope.addNewSteps = function(){
    $http({
    url: '/add_new_steps',
    method: 'POST',
    params: {countSteps: $scope.countSteps},
    headers: {
    'X-CSRF-TOKEN': $scope.csrf
    }
    }).then(function(){
    $scope.countSteps += 1;
    $scope.getSteps();
    });
    }

    $scope.deleteIngridients = function(id){
    $http({
    url: '/delete_adding_ingridients',
    method: 'DELETE',
    params: {ingId: id},
    headers: {
    'X-CSRF-TOKEN': $scope.csrf
    }
    }).then(function(){
    $scope.countIngridients -= 1;
    $scope.getIngridients();
    });
    }

    $scope.deleteSteps = function(id){
    $http({
    url: '/delete_adding_steps',
    method: 'DELETE',
    params: {stepId: id},
    headers: {
    'X-CSRF-TOKEN': $scope.csrf
    }
    }).then(function(){
    $scope.countSteps -= 1;
    $scope.getSteps();
    });
    }

    });
</script>
<body ng-app="RECIPES" ng-controller="RECIPES_CTRL">
<header th:insert="blocks/header :: header_profile"></header>

<div class="d-inline-flex mt-2 mt-md-0 ms-md-auto">
    <div>
        <h2 class="fs-4">Ингридиенты</h2>
        <div ng-if="ingridients.length != 0" class="album py-5 bg-body-tertiary">
            <div class="container">
                <div class="col">
                    <div ng-repeat="ing in ingridients">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <input ng-model="ing.title" type="text" class="form-control" name="title" placeholder="Заголовок ингридиентов" maxlength="50" required>
                                <input ng-model="ing.listOfIngridients" type="text" class="form-control" name="description" placeholder="Список ингридиентов(500 символов)" maxlength="500" required>
                                <button ng-if="ing.number == countIngridients" type="button" ng-click="deleteIngridients(ing.id)" class="btn btn-primary rounded-pill px-3">Удалить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button ng-if="countIngridients < 20" type="button" ng-click="addNewIngridients()" class="btn btn-primary rounded-pill px-3">Добавить еще</button>
    </div>
    <div>
        <h2 class="fs-4">Шаги</h2>
        <div ng-if="steps.length != 0" class="album py-5 bg-body-tertiary">
            <div class="container">
                <div class="col">
                    <div ng-repeat="st in steps">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <p>Шаг {{st.number}}</p>
                                <input ng-model="st.description" type="text" class="form-control" name="description" placeholder="Описание шага(500 символов)" maxlength="500" required>
                                <button ng-if="st.number == countSteps" type="button" ng-click="deleteSteps(st.id)" class="btn btn-primary rounded-pill px-3">Удалить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button ng-if="countSteps < 20" type="button" ng-click="addNewSteps()" class="btn btn-primary rounded-pill px-3">Добавить еще</button>
    </div>
</div>

<div th:insert="blocks/footer :: footer"></div>
</body>
</html>